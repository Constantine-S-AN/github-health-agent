<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GitHub Health Agent (Zypher + MCP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0; padding: 0; min-height: 100vh;
      background: #000; 
      color: #e5e5e5;
      display: flex; align-items: center; justify-content: center;
      overflow-x: hidden;
    }

    #canvas-container {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0; 
      pointer-events: none;
      transition: all 0.8s ease-in-out;
      background: radial-gradient(circle at top, #1f2933 0, #05060a 55%, #000 100%);
    }

    #canvas-container.processing-mode {
      z-index: 9999;
      background: #000;
      opacity: 1;
    }

    .shell { 
      width: 100%; max-width: 1100px; padding: 1.5rem; 
      position: relative; 
      z-index: 10; 
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    
    .shell.hidden {
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
    }
    
    .card {
      width: 100%; padding: 1.5rem 1.75rem; border-radius: 18px;
      background: rgba(10, 12, 20, 0.85); 
      box-shadow: 0 16px 40px rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      display: grid; grid-template-columns: minmax(0, 360px) minmax(0, 1fr); gap: 1.5rem;
    }
    @media (max-width: 900px) { .card { grid-template-columns: minmax(0, 1fr); } }

    .left { border-right: 1px solid rgba(255,255,255,0.06); padding-right: 1.25rem; }
    @media (max-width: 900px) { .left { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.06); padding-right: 0; padding-bottom: 1.25rem; } }
    .right { padding-left: 0.5rem; }

    h1 { margin: 0 0 0.4rem; font-size: 1.5rem; letter-spacing: 0.02em; }
    .subtitle { font-size: 0.85rem; color: #9ca3af; margin-bottom: 1rem; }
    
    .chip-row { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1.2rem; }
    .chip { padding: 0.18rem 0.55rem; border-radius: 999px; font-size: 0.7rem; border: 1px solid rgba(156,163,175,0.6); color: #d1d5db; background: rgba(15,23,42,0.8); display: inline-flex; align-items: center; gap: 0.25rem; }
    .chip span { font-size: 0.85em; opacity: 0.8; }

    .input-group { margin-bottom: 0.85rem; }
    .input-group label { display: block; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.08em; color: #9ca3af; margin-bottom: 0.35rem; }
    
    .pill-input, textarea, select {
      width: 100%; padding: 0.7rem 1rem; border-radius: 999px; 
      border: 1px solid rgba(148,163,184,0.7); background: rgba(15,23,42,0.8); 
      color: #e5e5e5; font-size: 0.9rem; outline: none;
    }
    textarea { border-radius: 12px; resize: vertical; min-height: 80px; }
    select { border-radius: 10px; background: rgba(15,23,42,0.9); }
    
    .pill-input:focus, textarea:focus, select:focus {
      border-color: #4f9cff; box-shadow: 0 0 0 1px rgba(79,156,255,0.6);
    }

    .mode-row { display: flex; gap: 0.9rem; flex-wrap: wrap; margin-top: 0.15rem; }
    .mode-pill {
      display: inline-flex; align-items: center; gap: 0.35rem;
      font-size: 0.78rem; color: #d1d5db; padding: 0.35rem 0.7rem;
      border-radius: 999px; background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7); cursor: pointer; transition: 0.2s;
    }
    .mode-pill.active {
      border-color: #4f9cff; background: rgba(79,156,255,0.15); color: #fff;
    }
    .mode-pill input { margin: 0; display: none; }
    .mode-note { font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem; }

    button {
      margin-top: 0.8rem; padding: 0.55rem 1.1rem; border-radius: 999px; border: none;
      cursor: pointer; background: linear-gradient(120deg, #4f9cff, #38bdf8);
      color: #020617; font-weight: 600; font-size: 0.9rem;
      display: inline-flex; align-items: center; gap: 0.35rem;
      box-shadow: 0 8px 20px rgba(56,189,248,0.45); transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.65; cursor: default; box-shadow: none; transform: none; }

    #status { margin-top: 0.6rem; font-size: 0.8rem; color: #9ca3af; white-space: pre-wrap; }
    #output { margin-top: 0.25rem; padding: 0.85rem; border-radius: 12px; background: rgba(15,23,42,0.9); color: #e5e5e5; max-height: 65vh; overflow: auto; font-size: 0.88rem; }
    
    .mermaid { background: #020617; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center; }
    #output .md-block { white-space: pre-wrap; word-break: break-word; margin: 0.3rem 0; }
    #output h1, #output h2, #output h3 { margin: 0.4rem 0 0.3rem; color: #e5e7eb; }
    #output ul { padding-left: 1.2rem; color: #cbd5f5; }
    #output strong { color: #38bdf8; }

    #loading-overlay-text {
      position: fixed;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 10000;
      font-size: 1.2rem; letter-spacing: 0.2em; color: #4f9cff;
      text-transform: uppercase;
      opacity: 0; pointer-events: none;
      transition: opacity 0.5s;
      text-shadow: 0 0 20px rgba(79, 156, 255, 0.8);
    }
    #loading-overlay-text.visible { opacity: 1; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

</head>
<body>

  <div id="canvas-container"></div>
  
  <div id="loading-overlay-text">Analyzing Repository Data...</div>

  <div class="shell" id="ui-shell">
    <div class="card">
      <div class="left">
        <h1>GitHub Health Agent</h1>
        <div class="subtitle">
          Zypher + MCP + Mermaid. Give it a repo, a scenario, and a task — it will scan, visualize, and fix things for you.
        </div>
        <div class="chip-row">
          <div class="chip"><span>●</span> Agent Loop</div>
          <div class="chip"><span>●</span> GitHub MCP</div>
          <div class="chip"><span>●</span> Mermaid Charts</div>
          <div class="chip"><span>●</span> Janitor (auto)</div>
        </div>

        <div class="input-group">
          <label for="repo-input">Target Repository</label>
          <input
            id="repo-input"
            class="pill-input"
            type="text"
            placeholder="e.g. Constantine-S-AN/github-health-agent"
            autocomplete="off"
          />
        </div>

        <div class="input-group">
          <label for="scenario-select">Scenario</label>
          <select id="scenario-select">
            <option value="health">Health – Overall repo health</option>
            <option value="backlog">Backlog Cleanup – Triage issues</option>
            <option value="release">Release Prep – Next release</option>
            <option value="custom">Custom Task – Use instruction</option>
            <option value="chat">Free Chat – Agent decides (auto-write)</option>
          </select>
        </div>

        <div class="input-group">
          <label for="task-input">Instruction / Task (optional)</label>
          <textarea
            id="task-input"
            placeholder="e.g., Help me clean up unlabeled issues and prepare a 2-week plan to stabilize CI."
          ></textarea>
        </div>

        <div class="input-group">
          <label>Execution Mode</label>
          <div class="mode-row">
            <label class="mode-pill active" id="pill-plan">
              <input type="radio" name="mode" value="plan" checked />
              Plan only
            </label>
            <label class="mode-pill" id="pill-auto">
              <input type="radio" name="mode" value="auto" />
              Auto (write actions)
            </label>
          </div>
        </div>

        <button id="analyze-btn">
          ▶ Initialize Scan Sequence
        </button>
        <div id="status"></div>
      </div>

      <div class="right">
        <div id="output"></div>
      </div>
    </div>
  </div>

  <script>
    window.setProcessingState = function() {};
    window.setScoreColor = function() {};

    (function() {
      if (typeof THREE === 'undefined') return;

      const container = document.getElementById('canvas-container');
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
      camera.position.z = 400;

      const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);

      const COLOR_DEFAULT = new THREE.Color(0x4f9cff); // 蓝 (默认)
      const COLOR_GOOD    = new THREE.Color(0x00ff9d); // 绿 (80+)
      const COLOR_WARN    = new THREE.Color(0xffae00); // 橙 (50-79)
      const COLOR_BAD     = new THREE.Color(0xff4444); // 红 (<50)

      let currentColor = COLOR_DEFAULT.clone();
      let targetColor  = COLOR_DEFAULT.clone();

      const geometry = new THREE.IcosahedronGeometry(220, 1);
      
      const wireframeMaterial = new THREE.MeshBasicMaterial({ 
          color: currentColor, wireframe: true, transparent: true, opacity: 0.25 
      });

      const pointsMaterial = new THREE.PointsMaterial({
          color: currentColor, size: 4, transparent: true, opacity: 0.6
      });

      const wireMesh = new THREE.Mesh(geometry, wireframeMaterial);
      const pointsMesh = new THREE.Points(geometry, pointsMaterial);
      const group = new THREE.Group();
      group.add(wireMesh);
      group.add(pointsMesh);
      scene.add(group);

      let mouseX = 0; 
      let mouseY = 0;
      let targetRotSpeed = 0.002;
      let currentRotSpeed = 0.002;

      document.addEventListener('mousemove', (event) => {
          mouseX = (event.clientX - window.innerWidth / 2) * 0.0005;
          mouseY = (event.clientY - window.innerHeight / 2) * 0.0005;
      });

      window.setProcessingState = function(isProcessing) {
        if (isProcessing) {
          targetRotSpeed = 0.05; // 加速
          wireframeMaterial.opacity = 0.5; // 变亮一点
          pointsMaterial.size = 5;
          // 处理中暂时用默认蓝色或白色
          targetColor.set(COLOR_DEFAULT); 
        } else {
          targetRotSpeed = 0.002; // 恢复
          wireframeMaterial.opacity = 0.25;
          pointsMaterial.size = 4;
        }
      };

      window.setScoreColor = function(score) {
        console.log("Setting color for score:", score);
        if (score === null || score === undefined) {
          targetColor.set(COLOR_DEFAULT);
        } else if (score >= 80) {
          targetColor.set(COLOR_GOOD);
        } else if (score >= 50) {
          targetColor.set(COLOR_WARN);
        } else {
          targetColor.set(COLOR_BAD);
        }
      };

      function animate() {
          requestAnimationFrame(animate);

          currentRotSpeed += (targetRotSpeed - currentRotSpeed) * 0.05;
          group.rotation.y += currentRotSpeed;
          group.rotation.x += currentRotSpeed * 0.5;

          wireframeMaterial.color.lerp(targetColor, 0.05);
          pointsMaterial.color.lerp(targetColor, 0.05);

          if (targetRotSpeed < 0.01) {
            group.rotation.y += mouseX * 0.05;
            group.rotation.x += mouseY * 0.05;
          }
          
          const time = Date.now() * 0.001;
          const scale = 1 + Math.sin(time) * 0.03;
          group.scale.set(scale, scale, scale);

          renderer.render(scene, camera);
      }
      animate();

      window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
      });
    })();
  </script>

  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: false, theme: "dark" });

    const repoInput = document.getElementById("repo-input");
    const scenarioSelect = document.getElementById("scenario-select");
    const taskInput = document.getElementById("task-input");
    const button = document.getElementById("analyze-btn");
    const statusEl = document.getElementById("status");
    const output = document.getElementById("output");
    
    const uiShell = document.getElementById("ui-shell");
    const canvasContainer = document.getElementById("canvas-container");
    const loadingText = document.getElementById("loading-overlay-text");

    const pillPlan = document.getElementById("pill-plan");
    const pillAuto = document.getElementById("pill-auto");
    const radioPlan = pillPlan.querySelector("input");
    const radioAuto = pillAuto.querySelector("input");

    function updateModeUI() {
      if (radioPlan.checked) {
        pillPlan.classList.add("active");
        pillAuto.classList.remove("active");
      } else {
        pillAuto.classList.add("active");
        pillPlan.classList.remove("active");
      }
    }
    pillPlan.addEventListener("click", (e) => { if(e.target !== radioPlan) radioPlan.checked = true; updateModeUI(); });
    pillAuto.addEventListener("click", (e) => { if(e.target !== radioAuto) radioAuto.checked = true; updateModeUI(); });
    function getMode() { return radioAuto.checked ? "auto" : "plan"; }

    function extractHealthScore(text) {
      // 尝试匹配 "Health Score: 85" 或 "Score: 85" 或 "Score: **85**"
      // 忽略大小写
      const regex = /(?:Health )?Score:?\s*(?:\*\*|`|')?(\d+)(?:\*\*|`|')?(?:\/100)?/i;
      const match = text.match(regex);
      if (match && match[1]) {
        return parseInt(match[1], 10);
      }
      return null;
    }

    async function analyze() {
      const repo = repoInput.value.trim();
      if (!repo) {
        console.warn("No repo input");
        statusEl.textContent = "⚠️ Please enter a GitHub repository URL.";
        return;
      }
      const scenario = scenarioSelect.value;
      const task = taskInput.value.trim();
      let mode = getMode();
      if (scenario === "chat") mode = "auto";

      uiShell.classList.add("hidden");
      canvasContainer.classList.add("processing-mode");
      loadingText.classList.add("visible");
      
      window.setProcessingState(true);
      window.setScoreColor(null); 

      button.disabled = true;
      output.innerHTML = "";

      try {
        const params = new URLSearchParams();
        params.set("repo", repo); params.set("mode", mode); params.set("scenario", scenario);
        if (task) params.set("task", task);

        const url = "/api/health?" + params.toString();
        const res = await fetch(url);
        
        await new Promise(r => setTimeout(r, 1500));

        if (!res.ok) {
          let msg = "Request failed with status " + res.status;
          try { const err = await res.json(); if (err && err.error) msg = err.error; } catch (_) {}
          throw new Error(msg);
        }
        const data = await res.json();
        
        uiShell.classList.remove("hidden");
        canvasContainer.classList.remove("processing-mode");
        loadingText.classList.remove("visible");
        window.setProcessingState(false); // 停止加速

        statusEl.textContent = `Done. Repo: ${data.repo} · Scenario: ${data.scenario} · Mode: ${data.mode}`;
        
        renderMarkdownWithMermaid(data.report);

        const score = extractHealthScore(data.report);
        if (score !== null) {
          statusEl.innerHTML += ` <span style="color:#fff; background:#333; padding:2px 6px; border-radius:4px;">Score: ${score}</span>`;
          window.setScoreColor(score); // 触发变色
        } else {
           window.setScoreColor(null);
        }

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
        
        uiShell.classList.remove("hidden");
        canvasContainer.classList.remove("processing-mode");
        loadingText.classList.remove("visible");
        window.setProcessingState(false);
        window.setScoreColor(0); 
      } finally {
        button.disabled = false;
        button.textContent = "▶ Initialize Scan Sequence";
      }
    }

    function renderMarkdownWithMermaid(text) {
      output.innerHTML = "";
      const parts = text.split(/(```mermaid[\s\S]*?```)/g);
      parts.forEach((part) => {
        if (!part.trim()) return;
        if (part.startsWith("```mermaid")) {
          const code = part.replace("```mermaid", "").replace("```", "").trim();
          const div = document.createElement("div");
          div.className = "mermaid";
          div.textContent = code;
          output.appendChild(div);
        } else {
          const div = document.createElement("div");
          div.className = "md-block";
          div.textContent = part;
          output.appendChild(div);
        }
      });
      mermaid.run({ nodes: output.querySelectorAll(".mermaid") });
    }

    button.addEventListener("click", analyze);
    repoInput.addEventListener("keydown", (e) => { if (e.key === "Enter") analyze(); });
  </script>
</body>
</html>
